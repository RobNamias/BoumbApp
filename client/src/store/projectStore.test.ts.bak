// @ts-nocheck
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { act, renderHook } from '@testing-library/react';
import { useProjectStore } from './projectStore';

// Mock AudioEngine to avoid Side Effects
vi.mock('../audio/AudioEngine', () => ({
    default: {
        setTrackVolume: vi.fn(),
        muteTrack: vi.fn(),
        soloTrack: vi.fn(),
        setTrackPan: vi.fn(),
        setTrackOutput: vi.fn(),
        setTrackNotes: vi.fn(),
        reloadTrack: vi.fn()
    }
}));

describe('useProjectStore (V2 - Track First)', () => {
    beforeEach(() => {
        const { result } = renderHook(() => useProjectStore());
        act(() => {
            result.current.reset();
        });
    });

    it('should initialize with default 6 Drum Tracks and 2 Synths', () => {
        const { result } = renderHook(() => useProjectStore());
        const tracks = result.current.project.tracks;

        expect(Object.keys(tracks).length).toBe(8); // 6 Drums + 2 Synths
        expect(tracks['track-kick'].name).toBe('Kick');
        expect(tracks['track-kick'].type).toBe('drums');
        expect(tracks['track-lead'].type).toBe('melody');
    });

    it('should create a new Drum Pattern with initialized clips for all drum tracks', () => {
        const { result } = renderHook(() => useProjectStore());

        let patternId = '';
        act(() => {
            patternId = result.current.createPattern('drums', 'My Drum Pattern');
        });

        const pattern = result.current.project.drumPatterns[patternId];
        expect(pattern).toBeDefined();
        expect(pattern.name).toBe('My Drum Pattern');

        // Should have a clip entry for the kick track
        expect(pattern.clips['track-kick']).toEqual([]);
    });

    it('should add a global track', () => {
        const { result } = renderHook(() => useProjectStore());
        let newTrackId = '';

        act(() => {
            newTrackId = result.current.addTrack('melody', 'New Synth', 'synth');
        });

        const track = result.current.project.tracks[newTrackId];
        expect(track).toBeDefined();
        expect(track.name).toBe('New Synth');
        expect(track.type).toBe('melody');
    });

    describe('Note Management', () => {
        it('should add a note to a unified pattern clip', () => {
            const { result } = renderHook(() => useProjectStore());
            // Use default pattern-d1
            const patternId = 'pattern-d1';
            const trackId = 'track-kick';
            const note = { time: '0:0:0', note: 'C4', duration: '16n', velocity: 0.9 };

            act(() => {
                result.current.addNote(patternId, trackId, note);
            });

            const pattern = result.current.project.drumPatterns[patternId];
            expect(pattern.clips[trackId]).toHaveLength(1);
            expect(pattern.clips[trackId][0]).toEqual(note);
        });

        it('should remove a note from a unified pattern clip', () => {
            const { result } = renderHook(() => useProjectStore());
            const patternId = 'pattern-d1';
            const trackId = 'track-kick';
            const note = { time: '0:0:0', note: 'C4', duration: '16n', velocity: 0.9 };

            act(() => {
                result.current.addNote(patternId, trackId, note);
                result.current.removeNote(patternId, trackId, note);
            });

            const pattern = result.current.project.drumPatterns[patternId];
            expect(pattern.clips[trackId]).toHaveLength(0);
        });
    });

    describe('Mixer & Instrument', () => {
        /*
                it('should update global track mixer', () => {
                     // updateTrackMixer removed in Phase 5
                });
        */

        it('should update track instrument (Sample Swap)', () => {
            const { result } = renderHook(() => useProjectStore());
            const trackId = 'track-kick';

            act(() => {
                result.current.updateTrackInstrument(trackId, { sampleId: 'kick_909' });
            });

            const track = result.current.project.tracks[trackId];
            expect(track.instrument.sampleId).toBe('kick_909');
        });
    });

    describe('Timeline (Unified)', () => {
        it('should add a timeline clip', () => {
            const { result } = renderHook(() => useProjectStore());
            const clip = { id: 'c1', patternId: 'p1', start: 0, duration: 32 };

            act(() => {
                result.current.addTimelineClip(clip);
            });

            // Note: We need to see if it ended up in default arrays or if we cleared them
            // The default project has clips, so we append.
            const clips = result.current.project.timeline.clips;
            expect(clips.find(c => c.id === 'c1')).toBeDefined();
        });
    });
});

/*
// --- Phase 5: Mixer & FX (TDD) ---
describe('Mixer Effects', () => {
    it('Legacy test removed - Effects are now on Mixer Channels', () => {});
});
*/

